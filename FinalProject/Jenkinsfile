pipeline {
agent {
  kubernetes {
    yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: python
    image: python:3.10-slim
    command: ['cat']
    tty: true
  - name: docker
    image: docker:26.1.3
    command: ['cat']
    tty: true
    volumeMounts:
    - mountPath: /var/run/docker.sock
      name: docker-sock
  volumes:
  - name: docker-sock
    hostPath:
      path: /var/run/docker.sock
"""
    defaultContainer 'python'
  }
}
  environment {
    APP_NAME   = "final-project"
    HELM_CHART = "FinalProject/helm/final-project"
    NAMESPACE  = "default"
  }
  stages {
    stage('Build') {
  steps {
    container('docker') {
      dir('FinalProject') {
        sh 'ls -l'
        sh 'docker build -t final-project:latest .'
      }
    }
  }
}
stage('Test') {
  steps {
    container('python') {
      sh '''
        python --version
        pip --version
        pip install -r FinalProject/requirements.txt
        pip install pytest
        pytest -v
      '''
    }
  }
stage('Lint Helm Chart') {
  steps {
    container('helm') {
      sh "helm lint ${HELM_CHART}"
    }
  }
}
   stage('Deploy') {
  steps {
    container('helm') {
      sh """
        helm upgrade --install ${APP_NAME} ${HELM_CHART} \
          --namespace ${NAMESPACE} \
          --create-namespace
      """
    }
  }
}
  post {
    always {
      echo "Pipeline finished"
    }
    success {
      echo "Pipeline succeeded ✅"
    }
    failure {
      echo "Pipeline failed ❌"
    }
  }
}

